## 马尔可夫链

​	马尔可夫链最早由安德烈·马尔可夫（Andrey Markov，即马尔可夫不等式的提出者）在1906年引入。其目的是证明大数定律也适用于非独立的随机变量。为了理解马尔可夫模型的起源，首先考虑一个**独立同分布**（$i.i.d.$）的随机变量序列 $ X_0, X_1, \ldots, X_n, \ldots $，其中 $ n $ 代表时间。这是我们在第10章中一直以来的假设，但对于现实世界现象的建模来说，独立性可能是一个过于严格的假设；这意味着 $ X_n $ 这个节点不提供关于其他时间点的信息。在另一个极端情况下，允许 $ X_n $ 之间有任意的交互会使得即使是计算最基本的事物也变得非常困难。在我们很快就会定义的一个精确意义上，马尔可夫链是一个**随机变量序列**（$r.v.s$），它们表现出**一阶相关性**。因此，马尔可夫链是完全独立和完全相关之间的一种比较好的**折中**。

​	自此，马尔可夫链在诸如生物学、博弈论、金融、机器学习和统计物理学等众多领域中变得极其重要。通过所谓的**马尔可夫链蒙特卡洛**（Markov Chain Monte Carlo，MCMC）算法，它们也广泛用于**复杂分布的模拟**。在本章中，我们将介绍马尔可夫链及其属性，在下一章中，我们将看一些MCMC技术的示例。

### 11.1 马尔可夫性质和转移矩阵

​	马尔可夫链“存在”于空间和时间上：$ X_n $ 的所有可能值集合被称为**状态空间**，而索引 $ n $ 代表过程随**时间**的演化。马尔可夫链的状态空间可以是离散的也可以是连续的，时间也可以是离散的或连续的（在连续时间设置中，我们可以想象一个对所有实数 $ t \geq 0 $ 都有定义的过程 $ X_t $）。在本章中，我们将专注于具有有限状态空间的离散状态、离散时间马尔可夫链。具体来说，我们将假设 $ X_n $ 在有限集合中取值，通常是 $\{1, 2, \ldots, M\}$ 或 $\{0, 1, \ldots, M\}$。

> **Definition 11.1.1 马尔可夫链（Markov Chain）**
>
> ​	一个在**状态空间（state space）** $\{1, 2, \ldots, M\}$ 中取值的随机变量序列 $ X_0, X_1, X_2, \ldots $ 被称为**马尔可夫链**，对于所有的 $ n \geq 0 $，有：
> $$
> P(X_{n+1} = j | X_n = i, X_{n-1} = i_{n-1}, \ldots, X_0 = i_0) = P(X_{n+1} = j | X_n = i)
> $$
> ​	上式中的 $ P(X_{n+1} = j | X_n = i) $ 称为从状态 $ i $ 转移到状态 $ j $ 的**转移概率（transition probability）**。

​	在本书中，当我们提到马尔可夫链时，我们将隐含假设它是**时间齐次（time-homogeneous）**的，这意味着转移概率 $ P(X_{n+1} = j | X_n = i) $ 对于所有时间 $ n $ 是相同的。但需要注意的是，文献中对于是否将“时间齐次马尔可夫链（time-homogeneous Markov chain）”或仅仅“马尔可夫链（Markov chain）”并没有统一的标准。

​	上述条件称为**马尔可夫性质（Markov property）**，它表示给定整个历史信息 $ X_0, X_1, X_2, \ldots, X_n $，只有最近信息 $ X_n $ 对预测 $ X_{n+1} $ 有用。如果我们把时间 $ n $ 看作现在，$ n $ 之前的时间看作过去，$ n $ 之后的时间看作未来，马尔可夫性质表明，给定现在的状态，过去状态和未来状态是**条件独立**的。马尔可夫性质极大地简化了条件概率的计算：我们不需要将整个过去信息作为条件，只需要根据最近的状态信息作为条件。

​	为了描述马尔可夫链的动态，我们需要知道从任一状态到任一其他状态的**转移概率**，即马尔可夫性质右侧的概率 $ P(X_{n+1} = j | X_n = i) $。这些信息可以编码在一个矩阵中，称为**转移矩阵**，其 $ (i, j) $ 项是整个链从状态 $ i $ 转移到状态 $ j $ 的一步概率。

> **Definition 11.1.2 转移矩阵（transition matrix）**
>
> ​	设$ X_0, X_1, X_2, \ldots $ 为一个状态空间为 $\{1, 2, \ldots, M\}$的马尔可夫链，并设 $ q_{ij} = P(X_{n+1} = j | X_n = i) $ 为从状态 $ i $ 到状态 $ j $ 的转移概率。$ M \times M $ 矩阵 $ Q = (q_{ij}) $ 称为链的转移矩阵。

​	注意 $ Q $ 是一个非负矩阵，其中每一行的和为1。这是因为从任何状态 $ i $ 出发，“移动到状态$1$”，“移动到$2$”，……，“移动到 $ M $” 是不相交的事件，因为链必须走向某处,它们的并集的概率为$1$。

> **Example 11.1.3（雨天-晴天马尔可夫链）**
>
> ​	假设在任何给定的一天，天气可能是雨天或晴天。如果今天是雨天，那么明天是雨天的概率是$\frac{1}{3}$，是晴天的概率是$2/3$。如果今天是晴天，那么明天是雨天的概率是$\frac{1}{2}$，是晴天的概率是$\frac{1}{2}$。令 $ X_n $ 为第 $ n $ 天的天气，$ X_0, X_1, X_2, \ldots $ 是在状态空间 $\{R, S\}$ 上的马尔可夫链，其中 $ R $ 代表雨天，$ S $ 代表晴天。我们知道马尔可夫性质得到满足，因为从过程的描述来看，只有今天的天气对预测明天的天气有影响。

​	链的转移矩阵为：

$$
\begin{array}{c|cc}
  & R & S \\
\hline
R & 1/3 & 2/3 \\
S & 1/2 & 1/2 \\
\end{array}
$$

​	第一行表示从状态 $ R $ 出发，我们以$\frac{1}{3}$的概率回到状态 $ R $，以$2/3$的概率转移到状态 $ S $。第二行表示从状态 $ S $ 出发，我们有$\frac{1}{2}$的机会移动到状态 $ R $，有$\frac{1}{2}$的机会留在状态 $ S $。我们也可以使用

$$
\begin{array}{c|cc}
  & S & R \\
\hline
S & 1/2 & 1/2 \\
R & 2/3 & 1/3 \\
\end{array}
$$

作为我们的转移矩阵。一般来说，如果马尔可夫链的状态没有明显的排序（如状态 $ R $ 和 $ S $），我们只需要固定状态的排序并始终如一地使用它。

​	马尔可夫链的转移概率也可以用图表表示。如下图所示，每个状态用一个圆圈表示，箭头指示可能的下一步状态转移；我们可以想象一个粒子在各个状态间徘徊，随机选择要遵循的箭头。在箭头旁边，我们写上相应的转移概率。

【】

​	如果明天的天气取决于今天的天气和昨天的天气怎么办？例如，在上图的情况下，新添假设：如果已经连续下了两天雨，那么明天一定是晴天，如果已经连续晴了两天，那么明天一定是雨天。在这些新的天气动态下，$ X_n $ 不再形成一个马尔可夫链，因为违反了马尔可夫性质：条件于今天的天气，但昨天的天气仍然可以为预测明天的天气提供有用的信息。

​	然而，通过扩大状态空间，我们可以创建一个新的马尔可夫链：对于 $ n \geq 1 $，令 $ Y_n = (X_{n-1}, X_n) $ 。那么 $ Y_1, Y_2, \ldots $ 是在状态空间 $\{(R, R),(R, S),(S, R),(S, S)\}$ 上的马尔可夫链。您可以验证新的转移矩阵是：

$$
\begin{array}{c|cc}
  & (R,R) & (R,S) &(S,R) & (S,S) \\
\hline
(R, R) & 0 & 1 & 0 & 0 \\
(R, S) & 0 & 0 & 1/2 & 1/2 \\
(S, R) & 1/3 & 2/3 & 0 & 0 \\
(S, S) & 0 & 0 & 1 & 0 \\
\end{array}
$$

并且其对应的图形表示如下图所示。

【】

​	类似地，我们可以通过进一步扩大状态空间来处理第三阶或第四阶的天气依赖性，以使马尔可夫性质成立。

​	一旦我们有了马尔可夫链的转移矩阵 $ Q $，就可以计算出更长时间尺度的转移概率。

> **Definition 11.1.4 $n$ 步转移概率**
>
> ​	从 $ i $ 到 $ j $ 的 $ n $ 步转移概率是在从 $ i $ 出发后刚好 $ n $ 步到达 $ j $ 的概率。我们用 $ q^{(n)}_{ij} $ 表示这个概率：
> $$
>  q^{(n)}_{ij} = P(X_n = j | X_0 = i)
> $$
> 注意
> $$
> q^{(2)}_{ij} = \sum_{k} q_{ik}q_{kj}
> $$
> 因为要在两步内从 $ i $ 到 $ j $，链必须先从 $ i $ 到某个中间状态 $ k $，然后从 $ k $ 到 $ j $；因为马尔可夫性质，这些转换是独立的。由于矩阵 $ Q^2 $ 的$(i,j)$项由矩阵乘法定义，所以矩阵 $ Q^2 $ 给出了两步转移的转移矩阵。由归纳法可以得到转移矩阵的第 $ n $ 次幂给出了 $ n $ 步转移概率：
> $$
> q^{(n)}_{ij} \text{是} Q^n \text{的} (i, j) \text{项}。
> $$

>  **Example 11.1.54-状态马尔可夫链的转移矩阵**
>
> ​	考虑图11.1中描绘的4状态马尔可夫链。当箭头上没有写概率时，如本例所示，意味着从给定状态出发的所有箭头都同样可能。例如，从状态1出发有3个箭头，所以转移 $1 \rightarrow 3$、$1 \rightarrow 2$ 和 $1 \rightarrow 1$ 都有$\frac{1}{3}$的概率。因此，链的转移矩阵是
> $$
> Q = \begin{pmatrix}
> 1/3 & 1/3 & 1/3 & 0 \\
> 0 & 0 & 1/2 & 1/2 \\
> 0 & 1 & 0 & 0 \\
> 1/2 & 0 & 0 & 1/2 \\
> \end{pmatrix}
> $$
> [图11.1 一个4状态马尔可夫链]

​	要计算从状态1出发，5步后链在状态3的概率，我们会查看 $ Q^5 $ 的 $ (1,3) $ 项。在这里，使用计算机找到 $ Q^5 $，

$$
Q^5 = \begin{pmatrix}
853/3888 & 509/1944 & 52/243 & 395/1296 \\
173/864 & 85/432 & 31/108 & 91/288 \\
37/144 & 29/72 & 1/9 & 11/48 \\
499/2592 & 395/1296 & 71/324 & 245/864 \\
\end{pmatrix}
$$

所以 $ q^{(5)}_{13} = 52/243 $。

​	使用第7章的语言，在给定马尔可夫链初始状态的条件下，转移矩阵$Q$给出了$X_1$的**条件概率分布**。具体来说，$ Q $ 的第 $ i $ 行是 $ X_1 $ 给定 $ X_0 = i $ 的条件概率质量函数（$PMF$），以行向量形式显示。类似地，$ Q^n $ 的第 $ i $ 行是 $ X_n $ 给定 $ X_0 = i $ 的条件$PMF$。

​	要获得 $ X_0, X_1, \ldots $ 的边际分布，我们需要指定不仅转移矩阵，还有链的初始条件。初始状态 $ X_0 $ 可以确定性地指定，或者根据某些分布随机指定。令 $ (t_1, t_2, \ldots, t_M) $ 为 $ X_0 $ 的$PMF$，以向量形式显示，即 $ t_i = P(X_0 = i) $。那么通过对所有状态使用全概率公式（LOTP）对所有状态求平均，链在任何时间的边际分布都可以从转移矩阵计算出来。

>  **Proposition 11.1.6 $X_n$ 的边际分布** 
>
> ​	定义 $ t = (t_1, t_2, \ldots, t_M) $ 为 $ t_i = P(X_0 = i) $，并将 $ t $ 视为行向量。那么 $ X_n $ 的边际分布由向量 $ tQ^n $ 给出。也就是说，$ tQ^n $ 的第 $ j $ 项是 $ P(X_n = j) $。

> **Proof：**
>
> ​	根据全概率公式，以 $ X_0 $ 为条件，链在 $ n $ 步后处于状态 $ j $​ 的概率是
> $$
> P(X_n = j) = \sum_{i=1}^{M} P(X_0 = i)P(X_n = j|X_0 = i) = \sum_{i=1}^{M} t_i q^{(n)}_{ij}，
> $$
> 按照矩阵乘法的定义，这是 $ tQ^n $ 的第 $ j $ 项。

>  **Example 11.1.7 4-状态马尔可夫链的边际分布**
>
> ​	再次考虑图11.1中显示的4状态马尔可夫链。假设初始条件是 $ t = (\frac{1}{4}, \frac{1}{4}, \frac{1}{4}, \frac{1}{4}) $，意味着链以相等的概率开始于四个状态中的任何一个。令 $ X_n $ 为时间 $ n $ 的链位置。那么 $ X_1 $ 的边际分布是
> $$
> tQ = (\frac{1}{4}, \frac{1}{4}, \frac{1}{4}, \frac{1}{4}) \begin{pmatrix}
> \frac{1}{3} & \frac{1}{3} & \frac{1}{3} & 0 \\
> 0 & 0 & \frac{1}{2} & \frac{1}{2} \\
> 0 & 1 & 0 & 0 \\
> \frac{1}{2} & 0 & 0 & \frac{1}{2} \\
> \end{pmatrix} = \ldots
> $$
> 
>
> $X_5$的边缘分布为
> $$
> 
> $$
> 上述计算过程需要使用计算机执行矩阵乘法。

### 11.2 状态分类

​	在本节中，我们将介绍一些术语来描述马尔可夫链的各种特性。马尔可夫链的状态可以根据它们在长期内是否被反复访问或最终被抛弃，分类为**常返态**或**瞬时态**。状态也可以根据它们的周期进行分类，周期是是链中连续访问某状态所间隔的最小时间。这些特性很重要，因为它们决定了马尔可夫链的长期行为，我们将在11.3节中研究这些行为。

​	常返态和瞬时态的概念最好通过具体示例来说明。在图11.2左侧所示的马尔可夫链中（之前在示例11.1.5中介绍过），这条链可以长期地进行下去，因为链可能从任何状态转移到任何一个另外的状态。相比之下，考虑图11.2右侧的链，并让粒子从状态1开始。一段时间内，链可能在由状态1、2和3形成的三角形中徘徊，但最终它将到达状态4，从那里它将永远无法返回到状态1、2或3。然后它将永远在状态4、5和6之间徘徊。状态1、2和3是**瞬时态**，状态4、5和6是**常返态**。

【图11.2 左：所有状态都是常返态的4状态马尔可夫链。右：状态1、2和3是瞬时态的6状态马尔可夫链。】

​	一般来说，这些概念定义如下：

> **Definition 11.2.1 常返态和瞬时态**
>
> ​	如果从马尔可夫链的状态 $ i $ 开始，链最终返回到 $ i $ 的概率为$1$，状态 $ i $ 是**常返态（recurrent）**。否则，状态是**瞬时态（transition）**——这意味着如果链从 $ i $ 开始，不再返回 $ i $ 的概率为正。

​	事实上，尽管瞬时态的定义只要求永远不返回到状态的概率为正，但我们可以说更强的是：只要离开 $ i $ 永远的概率为正，链**最终**将永远离开 $ i $。从长远来看，任何可能发生的事情都会发生（在一个有限的状态空间中）此外，我们可以找到返回到状态的次数的分布。

>  **Proposition 11.2.2 瞬时态状态返回的次数服从几何分布**
>
> ​	设 $ i $ 是马尔可夫链的一个**瞬时态**。假设从 $ i $ 开始，永远不返回 $ i $ 的概率是一个正数 $ p > 0 $。那么，从 $ i $ 开始，链返回 $ i $ 的次数在永远离开之前是**几何分布** $ \text{Geom}(p) $。

​	该命题的证明是通过几何分布的情境：每次链在 $ i $ 时，存在一个**伯努利试验**，如果链最终返回 $ i $ 则结果为“失败”，如果链永远离开 $ i $ 则为“成功”；由于马尔可夫性质这些实验独立。返回状态 $ i $ 的次数是在第一次成功之前的失败次数，与几何分布的故事相匹配。特别低，由于几何随机变量总是取有限值，这个命题告诉我们，在一些有限的访问次数之后，链将永远离开状态 $ i $。

​	如果状态的数量不是太大，分类状态为常返态或瞬时态的一种方法是绘制马尔可夫链的图，并使用在分析图11.2中的链时使用的类似方法。一个特殊的情况是当链**不可约**时，即从任何状态到任何其他状态都是可能的时，我们可以立即得出所有状态都是常返态的结论。

>  **Definition 11.2.3 不可约和可约链**
>
> ​	对于一个具有转移矩阵 $ Q $ 的马尔可夫链，如果对于任意两个状态 $ i $ 和 $ j $，都有可能在有限步数内（具有正概率）从 $ i $ 到 $ j $，则这个马尔可夫链是**不可约（irreducible）**的。也就是说，对于任何状态 $ i, j $，存在某个正整数 $ n $ 使得 $ Q^n $ 的 $ (i, j) $ 项为正。一个马尔可夫链如果不是不可约的，那它就是**可约（reducible）**的。

> **Proposition 11.2.4 不可约意味着所有状态都是常返态**
>
> ​	在一个具有有限状态空间的不可约马尔可夫链中，所有状态都是常返态。

> **Proof：**
>
> ​	很明显至少有一个状态必须是常返态；如果所有状态都是瞬时态的，链最终将永远离开所有状态并无处可去！不失一般性，假设状态1是常返态，并考虑任何其他状态 $ i $。我们知道 $ q^{(n)}_{1i} $ 对于某些 $ n $ 是正的，根据不可约的定义。因此，每次链在状态1时，都有一个正概率在接下来的 $ n $ 步后到达状态 $ i $。由于链无限次访问状态1，我们知道链终会从状态1到达状态 $ i $；每次访问状态1都可以看作是开始一次试验，其中“成功”定义为在最多 $ n $ 步内到达状态 $ i $。从状态 $ i $ 出发，链将返回状态1，因为状态1是常返态，并且根据相同的逻辑，它最终会再次到达状态 $ i $。通过归纳法，链将无限次访问状态 $ i $。由于 $ i $ 是任意的，我们得出结论所有状态都是常返态。

​	上述命题的逆命题是错误的；即一个可约的马尔可夫链的状态可能都是常返态。下面给出的马尔可夫链就是一个例子，它由两个“岛屿”状态马尔可夫链组成。

【】

> **11.2.5** 
>
> ​	**注意，常返态或瞬时态是马尔可夫链中每个状态的属性，而不可约性或可约性是整个链的属性。**

​	通过马尔可夫链的视角来看以下前几章中两个熟悉的问题。对于每一个问题，我们将确定常返态和瞬时态。

>  **Example 11.2.6 赌徒的破产问题的马尔可夫链**
>
> ​	在赌徒的破产问题中（示例 2.7.3），两个赌徒，A 和 B，分别以 $ i $ 和 $ N - i $ 美元开始，进行一系列1美元的赌注。在每一轮中，玩家A赢的概率为 $ p $，输的概率为 $ q = 1 - p $。让 $ X_n $ 为时间 $ n $ 时赌徒A的财富。那么 $ X_0, X_1, \ldots $ 是在状态空间 $\{0, 1, \ldots, N\}$ 上的一个马尔可夫链（链的图如下所示）。根据题设，$ X_0 = i $。
>
> []
>
> 一旦马尔可夫链达到$0$或$N$，表示A或B破产，链将永远停留在那个状态。我们在第2章证明了A或B破产的概率为$1$，所以对于除了$0$或$N$以外的任何起始状态 $ i $，马尔可夫链最终将被吸收到状态0或N，永远不再返回 $ i $。因此，对于这个马尔可夫链，状态$0$和$N$是常返态，其他所有状态是瞬时态。链是可约的，因为从状态$0$只能去状态$0$，从状态N只能去状态N。

>  **Example 11.2.7 收集优惠券问题的马尔可夫链**
>
> ​	在收集优惠券问题中（示例 4.3.12），有 $ C $ 种优惠券（或玩具）类型，我们一次次地收集，每次从 $ C $ 种优惠券类型中有放回采样。让 $ X_n $ 是我们在 $ n $ 次尝试后收集到的不同优惠券类型数量。那么 $ X_0, X_1, \ldots $ 是在状态空间 $\{0, 1, \ldots, C\}$ 上的一个马尔可夫链。根据题设，$ X_0 = 0 $。链的图如下所示。
>
> 【】
>
> ​	除了状态 $ C $ 之外，我们永远无法在离开一个状态后返回；收集中的优惠券类型数量只能随着时间增加。因此，所有状态除了 $ C $ 都是瞬时态的，$ C $ 是常返态。链是可约的，因为例如从状态2回到状态1是不可能的。

​	另一种分类状态的方法是根据它们的**周期**。状态的周期总结了连续两次访问某状态之间可以经过的时间。

>  **Definition 11.2.8 状态的周期，周期性和非周期性链**
>
> ​	马尔可夫链中状态 $ i $ 的**周期（period）**是从 $ i $ 开始返回 $ i $ 可能需要的步数的**最大公约数**（gcd）。也就是说，$ i $ 的周期是使得 $ Q^n $ 的 $ (i, i) $ 项为正的数 $ n $ 的最大公约数。（如果在从 $ i $ 开始后永远不可能返回 $ i $，则 $ i $ 的周期是无穷大。）如果状态的周期等于1，则称该状态为**非周期性状态**，否则为**周期性状态**。如果链的所有状态都是非周期性的，则称该链为非周期性的，否则为周期性的。

​	例如，让我们再次考虑图11.2中的两个马尔可夫链（在图11.3中再次显示）。我们首先考虑右侧的6-状态链。从状态1开始，可能在3步、6步、9步等之后回到状态$1$，但不可能在非$3$的倍数的步数后回到状态$1$。因此，状态1的周期是$3$。同样，状态$2$和$3$的周期也是$3$。另一方面，状态4、5和6的周期是$1$，但由于至少有一个状态的周期不是$1$，所以该链是周期性的。相比之下，在左侧的链中，所有状态都是非周期性的，因此该链是非周期性的。

【】

​	在示例11.2.6中的赌徒的破产链中，每个状态的周期是$2$，除了$0$和$N$，它们的周期是$1$。在收集优惠券链中，每个状态的周期是$1$，除了状态$0$，其周期是无穷大，因为不可能返回状态$0$。所以这两个链都不是非周期性的。

​	检查一个不可约链是否是**非周期性**的通常比看上去容易得多：下一个命题显示，我们只需要计算一个状态的周期，而不需要逐个状态检查其周期是否不为1。

> **Proposition 11.2.9 不可约链中的周期**
>
> ​	在一个不可约马尔可夫链中，所有状态都有相同的周期。

### 11.3 稳态分布

​	常返性和瞬时态性的概念对于理解马尔可夫链的长期行为非常重要。起初，链可能会在瞬时态中度过一段时间。然而，**最终**链会在常返态中度过所有时间。但是，它会在每个常返态中花费的时间比例呢？这个问题由链的**稳态分布（stationary distribution）**（也称为平稳分布（steady-state distribution））回答。我们将在本节中了解到，对于不可约和非周期性的马尔可夫链，稳态分布描述了链的**长期行为**，不论其初始条件如何。它既告诉我们在任何特定状态中长期存在的概率，也告诉我们链在该状态中花费的长期时间比例。

>  **Definition 11.3.1（稳态分布）**
>
> ​	若行向量 $ s = (s_1, \ldots, s_M) $ 满足 $ s_i \geq 0 $ 且 $ \sum_i s_i = 1 $，则对于具有转移矩阵 $ Q $ 的马尔可夫链，如果对所有的 $ j $ 都满足：
> $$
> \sum_i s_i q_{ij} = s_j，
> $$
> 则$ s $ 是一个**稳态分布**。这个线性方程组可以写成一个矩阵方程：
> $$
> sQ = s。
> $$
> ​	回想一下，如果 $ s $ 是 $ X_0 $ 的分布，那么 $ sQ $ 是 $ X_1 $ 的边际分布。因此，方程 $ sQ = s $ 意味着如果 $ X_0 $ 的分布是 $ s $，那么 $ X_1 $ 也有 $ s $ 的分布。但那么 $ X_2 $、$ X_3 $ 等也有 $ s $ 的分布。也就是说，一个初始分布为稳态分布 $ s $ 的马尔可夫链将**永远**保持在稳态分布中。

​	直观地理解马尔可夫链的稳态分布，可以想象大量粒子，每个粒子根据转移概率独立地在状态间跳跃。一段时间后，粒子系统将达到一个平衡，其中在每个时间周期内，离开一个状态的粒子数量将被进入该状态的粒子数量平衡，这对所有状态都成立。在这个平衡状态下，整个系统看起来是静止的，每个状态中的粒子比例由稳态分布给出。在定义 11.4.1 之后，我们将更多地探索稳态分布的这种观点。

> **11.3.2 稳态分布是边际分布，而非条件分布**
>
> ​	当马尔可夫链处于稳态分布时，$ X_n $ 的无条件概率质量函数 （$PMF$）对所有的 $ n $ 都等于 $ s $，但 $ X_n $ 给定 $ X_{n-1} = i $ 的条件$PMF$仍然由转移矩阵 $ Q $ 的第 $ i $ 行编码。

​	如果马尔可夫链从稳态分布开始，则所有的 $ X_n $ 都是同分布的（因为它们有相同的边际分布 $ s $），但它们不一定是独立的，因为 $ X_n $ 给定 $ X_{n-1} = i $ 的条件分布通常与 $ X_n $ 的边际分布不同。

> **11.3.3 共情魔法**
>
> ​	如果马尔可夫链从稳态分布开始，则所有 $ X_n $ 的边际分布都相等。这并不意味着 $ X_n $ 本身都相等（不同的变量可以具有相同的分布）；将随机变量 $ X_n $ 与它们的分布混淆是共情魔法的一个例子。

​	对于非常小的马尔可夫链，我们可以手算稳态分布，使用定义。下一个示例说明了这对于两状态链的情况。

> **Example 11.3.4 两状态链的稳态分布**
>
> ​	设一个马尔可夫链的转移矩阵如下：
> $$
> Q = \begin{pmatrix} \frac{1}{3} & \frac{2}{3} \\ \frac{1}{2} & \frac{1}{2} \end{pmatrix} 
> $$
> 此时稳态分布的形式为 $ s = (s, 1 - s) $，我们需要求解 $ s $：
> $$
> 
> $$

​	考虑线性代数的视角，对于方程$sQ=s$中的$s$是$Q$关于特征值1的左特征向量（具体在数学附录A.3节）。未来得到特征向量的一半形式（一个右特征向量），做转置：$Q^T s^T = s^T$，其中$T$表示转置。

#### 11.3.1 存在性和唯一性

​	稳态分布是否总是存在，是否是唯一的？事实证明，对于有限状态空间，稳态分布总是存在的。此外，在不可约马尔可夫链中，稳态分布是唯一的。

> **Theorem 11.3.5 稳态分布的存在性和唯一性**
>
> ​	对于任何不可约马尔可夫链，都存在唯一的稳态分布。在这个分布中，每个状态都有正概率。

​	定理是线性代数中称为佩龙-弗罗贝尼乌斯（Perrron-Frobenius）定理的结果的一个推论，该定理在数学附录的A.3节中陈述。

​	图11.3左侧的4状态链是不可约的：从图的角度来看，可以从任何地方沿着箭头到达任何地方；从转移矩阵 $ Q $ 的角度来看，$ Q^5 $ 的所有条目都是正的。因此，根据定理 11.3.5，链有一个唯一的稳态分布。

​	另一方面，示例 11.2.6 中的赌徒的破产链是可约的，所以定理不适用。事实证明，这个链有无限多个稳态分布。从长远来看，链要么最终停留在状态0（永远停留在那里），要么停留在状态 $ N $（永远停留在那里）。这暗示着，退化分布 $ s = (1, 0, \ldots, 0) $ 和 $ t = (0, 0, \ldots, 1) $ 都是稳态分布，很容易检查这一点。因此，任何加权组合 $ ps + (1 - p)t $，其中 $ 0 \leq p \leq 1 $，也是一个稳态分布，因为它总和为1，并且
$$
(ps + (1 - p)t)Q = psQ + (1 - p)tQ = ps + (1 - p)t
$$
其中，像往常一样，$ Q $ 是转移矩阵。

#### 11.3.2 收敛

​	我们已经非正式地陈述过，稳态分布描述了链的**长期行为**，从这个意义上说，如果我们运行链很长时间，$ X_n $ 的边际分布将收敛到稳态分布 $ s $。下一个定理陈述了这一点是正确的，只要链既是不可约又是非周期性的。那么，无论链的初始条件如何，$ X_n $ 的$PMF$都将随着 $ n \rightarrow \infty $ 收敛到**稳态分布**。这将稳态概念与马尔可夫链的长期行为联系起来。这里省去了证明。

> **Theorem 11.3.6 收敛到稳态分布**
>
> ​	设 $ X_0, X_1, \ldots $ 是一个具有稳态分布 $ s $ 和转移矩阵 $ Q $ 的不可约、非周期性马尔可夫链。那么 $ P(X_n = i) $ 随着 $ n \rightarrow \infty $ 收敛到 $ s_i $。从转移矩阵的角度来看，$ Q^n $ 收敛到一个每行都是 $ s $ 的矩阵。

​	因此，经过大量步骤后，无论链的初始条件如何，链处于状态 $ i $ 的概率接近稳态概率 $ s_i $。这使得不可约、非周期性链特别好处理。不可约性意味着对于每个 $ (i, j) $ 都有某个幂次 $ Q^m $ 使得 $ (i, j) $ 条目为正，但如果我们还假设非周期性，事实证明我们可以找到一个适用于所有 $ i, j $ 的 $ m $ 值。更准确地说，一个链是**不可约**和非周期性的，当且仅当某个幂次 $ Q^m $ 在所有条目中都为正。

​	直观上，需要非周期性的额外条件是为了排除只是绕圈子的链，比如下面示例中的链，或者一些链，例如，某些状态只能在偶数步后才能访问，而其他状态只能在奇数步后才能访问。

>  **Example 11.3.7 周期性链**
>
> ​	下图显示了一个每个状态的周期为5的周期性马尔可夫链。
>
> 【图11.4 一个周期性链。】
>
> ​	这个链条的转移矩阵为：
> $$
> 
> $$

​	不难证明 $ s = (1/5, 1/5, 1/5, 1/5, 1/5) $ 是这个链的一个稳态分布，并且根据定理 11.3.5，$ s $ 是唯一的。然而，假设链从 $ X_0 = 1 $ 开始。那么 $ X_n $ 的$PMF$将概率1分配给状态 $(n \mod 5) + 1$，并为所有其他状态分配0。特别是，它不会随着 $ n \rightarrow \infty $ 收敛到 $ s $。也不会有 $ Q^n $ 收敛到每行都是 $ s $ 的矩阵：链的转换是确定性的，所以 $ Q^n $ 总是由0和1组成。

​	最后，稳态分布告诉我们访问任何特定状态的平均时间间隔。

> **Theorem 11.3.8 返回期望时间**
>
> ​	设 $ X_0, X_1, \ldots $ 是具有稳态分布 $ s $ 的不可约马尔可夫链。设 $ r_i $ 是链返回到 $ i $ 所需的**期望**时间，给定它从 $ i $ 开始。那么 $ s_i = 1/r_i $。

​	下面是如何将定理应用到示例 11.3.4 中的两状态链。

>  **Example 11.3.9 两状态链的长期行为**
>
> ​	从长远来看，示例 11.3.4 中的链将在状态1中度过$3/7$的时间，在状态2中度过$4/7$的时间。从状态1开始，平均需要$7/3$步返回状态1。当$n \rightarrow \infty$时，转移矩阵的幂次将收敛到每行都是稳态分布$s$的矩阵：
> $$
> Q^n \rightarrow \begin{pmatrix} 3/7 & 4/7 \\ 3/7 & 4/7 \end{pmatrix}
> $$

#### 11.3.3 Google PageRank

​	接下来我们考虑一个**更大规模**的稳态分布示例，一个在具有数十亿互联节点的状态空间上的马尔可夫链：万维网。下一个示例解释了Google的创始人如何将网络浏览建模为一个马尔可夫链，然后使用其稳态分布来对网页的相关性进行排名。多年来，Google将这种方法，称为**PageRank**，描述为“我们软件的核心”。

​	假设你对某个主题感兴趣，比如国际象棋，所以你使用搜索引擎寻找关于国际象棋的有用网页。有成千上万的网页提到“国际象棋”这个词，因此搜索引擎需要处理的一个关键问题是以何种顺序显示搜索结果。在找到有信息内容之前，必须浏览成千上万的垃圾网页提及“国际象棋”将是一场灾难。

​	在网络的早期，用于这个排名问题的方法各不相同。例如，一些搜索引擎雇用人工决定哪些网页最有用，他们得工作就像博物馆馆长一样。但除了主观太强和昂贵之外，随着网络的增长，这很快变得不可行。其他人专注于站点上提到搜索词的次数。但是，一个不断提到“国际象棋”的网页可能不如一个简洁的参考网页或一个不反复提到该词的关于国际象棋的网页有用。此外，这种方法非常容易被滥用：一个垃圾网页可以通过重复列出大量单词来提高其排名。

​	上述两种方法都忽略了网页具有网络的**结构**：哪些网页链接到哪些其他网页？考虑链接结构可以大大改善搜索引擎的效果。作为第一次尝试，可以根据多少其他网页链接到它来对网页进行排名。也就是说，如果网页A链接到网页B，我们认为这是A对B的投票，并根据它们获得的投票数对网页进行排名。

​	但这同样非常容易被滥用：一个垃圾网页可以通过创建成千上万个链接到自己的垃圾网页来提高其排名。尽管每个网页都有平等的投票权似乎很民主，但来自可靠网页的入站链接比来自无信息网页的链接更有意义。Google的PageRank，由谢尔盖·布林和恰当地命名的拉里·佩奇于1998年引入，不仅根据链接到它的网页数量，而且根据这些网页的重要性来对网页的重要性进行排名。

​	考虑将网络视为一个有向网络——这就是它的本质。网络上的每个网页是一个节点，节点之间的链接代表网页之间的链接。例如，为了简化，假设网络只有4个网页，如下图所示相连。

【图11.5 毕竟这是一个小网络。】

​	想象某人随机浏览网页，从某个网页开始，然后随机点击链接从一个网页跳到另一个网页（对当前网页上的所有链接概率相等）。PageRank的想法是通过长期在该网页花费的时间比例来衡量网页的重要性。

​	当然，某些网页可能根本没有外部链接，比如上面的网页4。当上网的人遇到这样一个网页时，与其因为打开一个新的浏览器窗口而失望，倒不如均匀地访问随机也没。因此，没有链接的页面会被转换为连接到每个网页的页面，包括其自身。对于上面的示例，生成的转移矩阵是

$$
 Q=
\begin{pmatrix}
0 & \frac{1}{2} & 0 & \frac{1}{2} \\
\frac{1}{2} & 0 & \frac{1}{2} & 0 \\
0 & 0 & 0 & 1 \\
\frac{1}{4} & \frac{1}{4} & \frac{1}{4} & \frac{1}{4} \\
\end{pmatrix}
。
$$
​	一般来说，设 $ M $ 为网络上的网页数量，$ Q $ 为上述链描述的 $ M \times M $ 转移矩阵，$ s $ 为稳态分布（假设它存在且唯一）。将 $ s_j $ 视为衡量网页 $ j $ 重要性的指标。直观上，方程
$$
s_j = \sum_i s_i q_{ij}
$$
表示网页 $ j $ 的分数不仅应该基于有多少其他网页链接到它，还要基于其他页面的得分。此外，如果一个网页有很多外部链接，它的“投票权”将被稀释：如果网页 $ i $ 唯一的链接是到网页 $ j $（即 $ q_{ij} = 1 $），那么它比网页 $ i $ 有成千上万个链接中恰好有一个链接到网页 $ j $ 时更重要。

​	对于这个链来说，是否存在唯一的稳态分布并不清楚，因为它可能不是不可约且非周期性的。即使它满足条件，由于网络如此庞大，收敛到稳态分布可能非常慢。为了解决这些问题，假设在每次移动之前，网络浏览者抛掷一枚硬币，正面朝上的概率为 $ \alpha $。如果是正面朝上，网络浏览者从当前网页点击一个随机链接；如果是反面朝上，网络浏览者会传送到一个均匀随机的网页。结果产生的链具有如下**Google转移矩阵**：
$$
G = \alpha Q + (1 - \alpha) \frac{J}{M}，
$$
其中， $ J $ 是所有元素为$1$的 $ M \times M $ 矩阵。请注意，$ G $ 的行和为1，并且所有条目都是正的，因此 $ G $ 是一个不可约、非周期性马尔可夫链的有效转移矩阵。这意味着存在一个唯一的稳态分布 $ s $，称为PageRank，链将收敛到它！$ \alpha $ 的选择是一个重要考虑因素；选择接近1的 $ \alpha $ 可以尽可能多地尊重网络的结构，但由于较小的 $ \alpha $ 值使链收敛得更快。作为折中，布林和佩奇的最初推荐是 $ \alpha = 0.85 $。

​	PageRank在概念上是很好的，但考虑到 $ sG = s $ 可能是1000亿个方程中的1000亿个未知数的系统，计算它听起来极其困难。为此，我们可以利用马尔可夫链的解释，而非将其视为一个庞大的代数问题：对于任何起始分布 $ t $，当 $ n \rightarrow \infty $时，$ tG^n \rightarrow s $。而且 $ tG $ 的计算比起初看上去容易得多：
$$
tG = \alpha(tQ) + \frac{1 - \alpha}{M}(tJ)，
$$
其中计算第一项不太困难，因为 $ Q $ 非常稀疏（大部分是0），计算第二项很也容易，因为 $ tJ $ 是一个全1的向量。然后 $ tG $ 成为新的 $ t $，我们可以计算 $ tG^2 = (tG)G $ 等，直到序列看起来已经收敛（尽管很难知道它是否真的收敛）。这给出了PageRank的近似值，并且具有直观的解释，即网络浏览者在大量点击网页后所处的分布。

### 11.4 可逆性

​	我们已经看到，马尔可夫链的**稳态分布**对于理解其**长期行为**非常有用。不幸的是，一般来说，当状态空间很大时，找到稳态分布可能在计算上很困难。本节讨论一个重要的特殊情况，即可以避免处理大矩阵的特征值方程。

> **Definition 11.4.1 可逆性（reversibility）**
>
> ​	设 $ Q = (q_{ij}) $ 是一个马尔可夫链的转移矩阵。假设存在 $ s = (s_1, \ldots, s_M) $ 满足 $ s_i \geq 0 $，$\sum_i s_i = 1$，使得
> $$
>  s_i q_{ij} = s_j q_{ji} 
> $$
>
> 对所有状态 $ i $ 和 $ j $ 都成立。这个方程被称为**可逆性**或**详细平衡（detailed balance）**条件，如果它成立，我们说该链相对于 $ s $ 是**可逆的**。

​	“可逆”一词来自于这样一个事实：根据其稳态分布开始的可逆链，无论时间是向前还是向后运行，行为都是相同的。如果你记录一个根据其稳态分布开始的可逆链的视频，然后以正常方式或时间倒流的方式向朋友展示，你的朋友将无法从观看视频中判断视频时间是向前还是向后运行。

​	正如在定义 11.3.1 之后讨论的那样，我们可以直观地将马尔可夫链的稳态分布视为由大量粒子组成的系统，这些粒子根据转移概率独立地在状态间跳跃。从长期来看，任何状态 $ j $ 中的粒子比例是状态 $ j $ 的稳态概率，从状态 $ j $ 流出的粒子被流入状态 $ j $ 的粒子平衡。为了更详细地看到这一点，设 $ n $ 为粒子数量，$ s $ 为概率向量，使得 $ s_j $ 是当前状态 $ j $ 中的粒子比例。根据定义，$ s $ 是链的稳态分布当且仅当
$$
 s_j = \sum_i s_i q_{ij} = s_j q_{jj} + \sum_{i: i \neq j} s_i q_{ij}
$$
对所有状态 $ j $ 都成立。这个方程可以重写为：
$$
n s_j (1 - q_{jj}) = \sum_{i: i \neq j} n s_i q_{ij}
$$
等式左边是下一步将从状态 $ j $ 退出的粒子的大致数量，因为有 $ n s_j $ 个粒子在状态 $ j $，每个粒子以概率 $ q_{jj} $ 留在 $ j $，以概率 $ 1 - q_{jj} $ 离开。右边是下一步将进入状态 $ j $ 的粒子的大致数量，因为对于每个 $ i \neq j $，有 $ n s_i $ 个粒子在状态 $ i $，每个粒子以概率 $ q_{ij} $ 进入状态 $ j $。所以状态 $ j $ 的离开和进入是**平衡**的。

​	可逆性条件强加了一种更严格的平衡形式，在这种平衡中，对于每对状态 $ i $ 和 $ j $（$ i \neq j $），从状态 $ i $ 到状态 $ j $ 的粒子流与从状态 $ j $ 到状态 $ i $ 的粒子流相平衡。为了看到这一点，将可逆性方程对状态 $ i $ 和 $ j $ 写为
$$
 n s_i q_{ij} = n s_j q_{ji}
$$
左边是下一步将从状态 $ i $ 到状态 $ j $ 的粒子的大致数量，因为有 $ n s_i $ 个粒子在状态 $ i $，每个粒子都有概率 $ q_{ij} $ 去状态 $ j $。类似地，右边是下一步将从状态 $ j $ 到状态 $ i $ 的粒子的大致数量。所以可逆性意味着从状态 $ i $ 到状态 $ j $ 和从状态 $ j $ 到状态 $ i $ 的粒子流是平衡的。

​	给定一个转移矩阵，如果我们可以找到满足可逆性条件的概率向量 $ s $，那么 $ s $ 就自动成为一个稳态分布。鉴于上述讨论，这并不奇怪。

>  **Proposition 11.4.2 可逆性意味着稳态性**
>
> ​	假设 $ Q = (q_{ij}) $ 是一个相对于非负向量 $ s = (s_1, \ldots, s_M) $（其分量之和为$1$）可逆的马尔可夫链的转移矩阵。那么 $ s $ 是链的一个稳态分布。

> **Proof：**
>
> ​	我们有
> $$
> \sum_i s_i q_{ij} = \sum_i s_j q_{ji} = s_j \sum_i q_{ji} = s_j，
> $$
> 其中最后一个等式是因为 $ Q $ 的每行和为1。所以 $ s $ 是稳态的。

​	这是一个强有力的结果，因为验证可逆性条件通常比求解整个方程组 $ sQ = s $ 更容易。然而，一般来说，我们可能无法预先知道是否可能找到满足可逆性条件的 $ s $，即使可能，找到一个有效的 $ s $ 也可能需要很多努力。在本节的剩余部分，我们将研究三种类型的马尔可夫链，在这些链中可以找到满足可逆性条件的 $ s $。这样的马尔可夫链被称为**可逆的**。

​	首先，如果 $ Q $ 是一个对称矩阵，那么稳态分布在状态空间上是均匀的：$ s = (\frac{1}{M}, \frac{1}{M}, \ldots, \frac{1}{M}) $。很容易看出，如果 $ q_{ij} = q_{ji} $，那么当 $ s_i = s_j $ 对所有的 $ i $ 和 $ j $ 都成立时，可逆性条件 $ s_i q_{ij} = s_j q_{ji} $ 就满足了。

​	对称矩阵是一个更一般事实的特例，如下所述：如果 $ Q $ 的每一列和为1，那么稳态分布在状态空间上是均匀的。

> **Proposition 11.4.3**
>
> ​	如果转移矩阵 $ Q $ 的每一列和为1，那么所有状态上的均匀分布 $(\frac{1}{M}, \frac{1}{M}, \ldots, \frac{1}{M})$ 是一个稳态分布。（每行和每列的和都等于1的非负矩阵称为**双随机矩阵（doubly stochastic matrix）**。）

> **Proof：**
>
> ​	假设每一列和为1，行向量 $ v = (1, 1, \ldots, 1) $ 满足 $ vQ = v $。因此 $(\frac{1}{M}, \frac{1}{M}, \ldots, \frac{1}{M})$ 是稳态的。

​	其次，如果马尔可夫链是在无向网络上的**随机游走**，则稳态分布有一个简单的公式。

>  **Example 11.4.4 无向网络上的随机游走**
>
> ​	网络是由**节点（nodes）**通过**边（edges）**连接而成的集合；如果边可以双向穿行，则网络是**无向的（undirected）**，这意味着没有单行道。假设一个漫游者随机穿越无向网络的边。在节点 $ i $ 处，漫游者随机选择 $ i $ 处的任何一条边，然后穿越所选择的边。例如，在下面所示的网络中，从节点3，漫游者以$\frac{1}{2}$​的概率前往节点1或节点2。
>
> 【】
>
> ​	节点的**度（degree）**是连接到它的边的数量，网络中节点1、2、$\ldots$、$ n $ 的度序列是列出所有度的向量 $(d_1, \ldots, d_n)$，其中 $ d_j $ 是节点 $ j $ 的度。允许从节点到自身的边（这样的边称为**自环（self-loop）**），并将其计为该节点的度的一部分。	

​	例如，上述网络的度序列是 $ d = (4, 3, 2, 3, 2) $。注意 $ d_i q_{ij} = d_j q_{ji} $ 对所有的 $ i, j $ 都成立，因为当$ i \neq j $时，$\{i, j\}$ 是一条边，则 $ q_{ij} = 1/d_i $，否则为0；$i = j $时显然成立。因此，根据命题 11.4.2，稳态分布与度序列成比例。直观上，度数最高的节点是最有连接性的，所以长期来看，链在这些状态中度过最多时间是有道理的。在上面的例子中，这意味着$ s = \left(\frac{4}{14}, \frac{3}{14}, \frac{2}{14}, \frac{3}{14}, \frac{2}{14}\right) $是随机游走的稳态分布。

​	练习20探讨了在加权无向网络上的随机游走；每条边都有一个权重分配，漫游者从 $ i $ 出发，根据可用边上的权重按比例选择去向。事实证明，这是一个可逆的马尔可夫链。更令人惊讶的是，**每个可逆的马尔可夫链都可以表示为加权无向网络上的随机游走！**

​	下面是一个无向网络上随机游走的具体示例。

>  **Example 11.4.5 棋盘上的骑士**
>
> ​	考虑一个骑士在4×4的棋盘上随机移动。
>
> ​	在16个被标记在网格上的正方形中，例如，骑士目前位于B3方格，左上方的方格是A4。骑士的每一步都是L型跳跃：骑士横向移动两个方格，然后纵向移动一个方格，反之亦然。例如，从B3，骑士可以移动到A1、C1、D2或D4；从A4，它可以移动到B2或C3。注意从浅色方格，骑士总是移动到深色方格，反之亦然。

​	假设在每一步中，骑士随机移动，每种可能性都同样可能。这就创建了一个马尔可夫链，其中状态是16个方格。计算该链的稳态分布。

> **Solution：**
> 	棋盘上只有三种类型的方格：4个中心方格、4个角落方格（如A4）和8个边缘方格（如B4；不将角落方格视为边缘方格）。我们可以将棋盘视为一个无向网络，如果两个方格可以通过单次骑士的移动到达，则它们由边连接。那么中心方格的度为4，角落方格的度为2，边缘方格的度为3，因此它们的稳态概率分别为$4a$、$2a$、$3a$，其中 $ a $​ 为某个数值。
>
> ​	为了找到 $ a $，统计每种类型方格的数量得到 $ 4a \times 4 + 2a \times 4 + 3a \times 8 = 1 $，得出 $ a = \frac{1}{48} $。因此，每个中心方格的稳态概率为 $ \frac{4}{48} = \frac{1}{12} $，每个角落方格的稳态概率为 $ \frac{2}{48} = \frac{1}{24} $，每个边缘方格的稳态概率为 $ \frac{3}{48} = \frac{1}{16} $。

​	第三个类型：如果在每个时间周期内，一个马尔可夫链只能向左移动一步、向右移动一步或保持不动，则称为**生死链**。所有生死链都是可逆的。

>  **Example 11.4.6 生死链（Birth-death chain）**
>
> ​	在状态 $\{1, 2, \ldots, M\}$ 上的**生死链**是一个具有转移矩阵 $ Q = (q_{ij}) $ 的马尔可夫链，使得 $ q_{ij} > 0 $ 当且仅当 $ |i - j| = 1 $ 并且 $ q_{ij} = 0 $ 当且仅当 $ |i - j| \geq 2 $​。这意味着可以向左走一步和向右走一步是可能的（除了边界），但一步之内跳得更远是不可能的。这个名字源于对人口增长或衰减的应用，其中向右的一步被认为是出生，向左的一步被认为是人口的死亡。
>
> ​	例如，下面显示的链是一个生死链，如果标记的转换有正概率，除了从状态到其自身的循环，这些循环可以有0概率。
>
> []

​	我们现在将证明任何生死链都是可逆的，并构造稳态分布。设 $ s_1 $ 为一个正数，稍后再指定具体数值。由于我们希望 $ s_1 q_{12} = s_2 q_{21} $，让$s_2 = \frac{s_1 q_{12}}{q_{21}}$，然后想得到 $ s_2 q_{23} = s_3 q_{32} $，则令$ s_3 = \frac{s_2 q_{23}}  {q_{32}} = \frac{s_1 q_{12} q_{23} }{ (q_{32} q_{21})} $以此类推，令
$$
s_j = s_1 q_{12} q_{23} \ldots q_{j-1,j} / (q_{j,j-1} q_{j-1,j-2} \ldots q_{21})
$$
对于所有 $ 2 \leq j \leq M $ 的状态 $ j $成立。选择 $ s_1 $ 使 $ s_j $ 的和为1。那么链相对于 $ s $ 是可逆的，因为如果 $ |i - j| \geq 2 $ 则 $ q_{ij} = q_{ji} = 0 $，并且根据构造如果 $ |i - j| = 1 $ 则 $ s_i q_{ij} = s_j q_{ji} $。因此，$ s $ 是稳态分布。

​	埃伦菲斯特（Ehrenfest）链是一个可以用作气体扩散的简单模型的生死链。其稳态分布事实证明是一个二项分布。

> **Example 11.4.7 Ehrenfest**
>
> ​	有两个容器，总共有 $ M $ 个可区分的粒子。转换是通过选择一个随机粒子并将其从当前容器移动到另一个容器来进行的。最初，所有粒子都在第二个容器中。设 $ X_n $ 为时间 $ n $ 时第一个容器中的粒子数量，所以 $ X_0 = 0 $，从 $ X_n $ 到 $ X_{n+1} $ 的转换如上所述进行。这是一个周期为2的马尔可夫链，状态空间为 $\{0, 1, \ldots, M\}$​。
>
> 【】

​	正如上面所示，第一个容器有 $ X_n $ 个粒子，第二个容器有 $ M - X_n $ 个粒子。我们将使用可逆性条件证明 $ s = (s_0, s_1, \ldots, s_M) $ ，其中$ s_i = \binom{M}{i} \left(\frac{1}{2}\right)^M $是稳态分布。注意这是 $ \text{Bin}(M, \frac{1}{2}) $ 的$PMF$。

​	让 $ s_i $ 如所声称，并检查 $ s_i q_{ij} = s_j q_{ji} $。如果 $ j = i + 1 $（$ i < M $），那么
$$
 s_i q_{ij} = \binom{M}{i} \left(\frac{1}{2}\right)^M \frac{M}{M - i} = \binom{M}{i - 1} \left(\frac{1}{2}\right)^M，\\
s_j q_{ji} = \binom{M}{j} \left(\frac{1}{2}\right)^M \frac{j}{M} = \binom{M}{j - 1} \left(\frac{1}{2}\right)^M = s_i q_{ij}
$$
​	类似地，如果 $ j = i - 1 $（$ i > 0 $），那么 $ s_i q_{ij} = s_j q_{ji} $。对于所有其他的 $ i $ 和 $ j $ 值，$ q_{ij} = q_{ji} = 0 $。因此，$ s $ 是稳态的。

​	由于在马尔可夫链运行很长时间后，每个粒子大致有相同的概率在两个容器中的任何一个中，二项分布是稳态分布的自然猜测。然而，由于链的周期为2，所以 $ X_n $ 的$PMF$不会收敛到二项分布，因为当 $ n $ 为偶数时，$ X_n $ 保证为偶数，而当 $ n $ 为奇数时为奇数。

​	值得庆幸的是，稳态分布的另一种解释仍然有效：$ s_i $ 是链在状态 $ i $ 中度过的长期时间比例。更确切地说，设 $ I_k $ 为链在时间 $ k $ 处于状态 $ i $ 的指示器，可以证明
$$
\frac{1}{n} \sum_{k=0}^{n-1} I_k \rightarrow s_i，
$$
随着 $ n \rightarrow \infty $，依概率1收敛。

### 11.5 总结

​	马尔可夫链是满足马尔可夫性质的**随机变量序列** $ X_0, X_1, X_2, \ldots $，该性质指出给定现在状态信息，过去状态和未来状态是条件独立的：
$$
 P(X_{n+1} = j | X_n = i, X_{n-1} = i_{n-1}, \ldots, X_0 = i_0) = P(X_{n+1} = j | X_n = i) = q_{ij}
$$
​	**转移矩阵** $ Q = (q_{ij}) $ 给出了一步内从任何状态到任何其他状态的概率。转移矩阵的第 $ i $ 行是给定 $ X_n = i $ 时 $ X_{n+1} $ 的条件$PMF$。转移矩阵的 $ n $ 次幂给出了 $ n $ 步转移概率。如果我们指定初始条件 $ s_i = P(X_0 = i) $ 并让 $ s = (s_1, \ldots, s_M) $，那么 $ X_n $ 的边际$PMF$是 $ sQ^n $。

​	马尔可夫链的**某一状态**可以被分类为**常返态**或**瞬时态**：如果链将反复返回到某一状态，则为常返态；如果它最终将永远离开，则为瞬时态。状态也可以根据它们的周期进行分类；状态 $ i $ 的周期是从 $ i $ 开始返回 $ i $ 所需步数的**最大公约数**。如果从任何状态到任何状态都可以在有限步数内到达，则链是**不可约**的；如果每个状态的周期为1，则为**非周期性**的。

​	对于有限马尔可夫链，稳态分布是满足 $ sQ = s $ 的$PMF$。在一些条件下，有限马尔可夫链的稳态分布**存在**且是**唯一**的，随着 $ n \rightarrow \infty $，$ X_n $ 的$PMF$会**收敛**到 $ s $。如果状态 $ i $ 的稳态概率是 $ s_i $，那么从 $ i $ 开始链返回到 $ i $ 的**时间期望**是 $ r_i = 1/s_i $。

​	如果$PMF$ $ s $ 对所有的 $ i $ 和 $ j $ 都满足可逆性条件 $ s_i q_{ij} = s_j q_{ji} $ ，则保证 $ s $ 是具有转移矩阵 $ Q = (q_{ij}) $ 的马尔可夫链的稳态分布。满足可逆性条件的马尔可夫链被称为**可逆的**。我们讨论了三种类型的可逆链：

1. 如果转移矩阵是**对称**的，则稳态分布在所有状态上是均匀的。
2. 如果链是在无向网络上的**随机游走**，则稳态分布与度序列成比例，即
   $$
   s_j = \frac{d_j}{\sum_i d_i}
   $$
3. 如果链是一个**生死链**，则稳态分布满足
   $$
   s_j = s_1 q_{12} q_{23} \ldots q_{j-1,j} / (q_{j,j-1} q_{j-1,j-2} \ldots q_{21})
   $$
   对于 $ j > 1 $均成立，其中 $ s_1 $ 在最后被解出以使 $ s_1 + \ldots + s_M = 1 $成立。

   

​	图11.6 比较了两种运行具有转移矩阵 $ Q $ 的马尔可夫链的方式：根据状态上的任意分布 $ t $ 选择初始状态，或根据稳态分布 $ s $ 选择初始状态。在前一种情况下，$ n $ 步后的精确$PMF$可以根据 $ Q $ 和 $ t $ 确定，并且$PMF$会收敛到 $ s $（在本章讨论的一些非常普遍的条件下）。在后一种情况下，链永远保持稳态。



【图11.6

给定一个转移矩阵 $ Q $ 和状态上的一个分布 $ t $，我们可以通过根据 $ t $ 选择 $ X_0 $ 然后根据转移概率运行链来生成马尔可夫链 $ X_0, X_1, \ldots $。一个重要事件是 $ X_n = i $，即链在时间 $ n $ 访问状态 $ i $。我们可以根据 $ Q $ 和 $ t $ 找到 $ X_n $ 的PMF，并且（在本章讨论的一些非常普遍的条件下）$PMF$将收敛到稳态分布 $ s $。如果我们根据 $ s $ 启动链，那么链将永远保持稳态。】





